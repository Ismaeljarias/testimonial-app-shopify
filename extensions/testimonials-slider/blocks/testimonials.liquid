{% comment %}
  Testimonials Slider - Up to 3 testimonials
  Only shows testimonials with names filled in
  Automatically becomes slider if 2+ testimonials
{% endcomment %}

{{ 'testimonials.css' | asset_url | stylesheet_tag }}

{% assign testimonial_count = 0 %}
{% for i in (1..3) %}
  {% assign name_key = 'name_' | append: i %}
  {% if block.settings[name_key] != blank %}
    {% assign testimonial_count = testimonial_count | plus: 1 %}
  {% endif %}
{% endfor %}

{% if testimonial_count > 0 %}
<div class="testimonials-slider{% if testimonial_count == 1 %} single-testimonial{% endif %}" data-testimonials-slider="{{ testimonial_count }}" style="--arrow-color: {{ block.settings.arrow_color }}; --arrow-hover-color: {{ block.settings.arrow_hover_color }}; --dot-color: {{ block.settings.dot_color }}; --dot-active-color: {{ block.settings.dot_active_color }}; --dot-hover-color: {{ block.settings.dot_hover_color }};">
  <div class="testimonials-container">
    <div class="testimonials-track" role="region" aria-label="Customer testimonials">
      {% for i in (1..3) %}
        {% assign avatar_key = 'avatar_' | append: i %}
        {% assign name_key = 'name_' | append: i %}
        {% assign rating_key = 'rating_' | append: i %}
        {% assign review_key = 'review_' | append: i %}
        
        {% if block.settings[name_key] != blank %}
          <div class="testimonial-card" role="group" aria-label="Testimonial">
            <div class="testimonial-layout">
              <div class="testimonial-avatar">
                {% if block.settings[avatar_key] != blank %}
                  <img 
                    src="{{ block.settings[avatar_key] | image_url: width: 80 }}" 
                    alt="{{ block.settings[name_key] }}"
                    width="80"
                    height="80"
                    loading="lazy"
                  >
                {% else %}
                  <div class="avatar-placeholder" aria-hidden="true">
                    {{ block.settings[name_key] | slice: 0 | upcase }}
                  </div>
                {% endif %}
              </div>
              
              <div class="testimonial-content">
                <div class="testimonial-header">
                  <h3 class="testimonial-name">{{ block.settings[name_key] }}</h3>
                  <div class="testimonial-rating" role="img" aria-label="{{ block.settings[rating_key] }} out of 5 stars">
                    {% assign rating_num = block.settings[rating_key] | plus: 0 %}
                    {% for star in (1..5) %}
                      <span class="star {% if star <= rating_num %}filled{% endif %}" aria-hidden="true">★</span>
                    {% endfor %}
                  </div>
                </div>
                <p class="testimonial-review">{{ block.settings[review_key] }}</p>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  {% if testimonial_count > 1 %}
    <div class="testimonials-controls">
      <button 
        class="testimonial-nav prev" 
        aria-label="Previous testimonial"
        data-nav="prev"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>

      <div class="testimonials-indicators" role="tablist" aria-label="Testimonial navigation">
        <svg class="gooey-filter" aria-hidden="true">
          <defs>
            <filter id="gooey-{{ block.id }}">
              <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur" />
              <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 15 -8" result="gooey" />
              <feComposite in="SourceGraphic" in2="gooey" operator="atop"/>
            </filter>
          </defs>
        </svg>
        <div class="indicators-wrapper" data-indicators style="filter: url(#gooey-{{ block.id }})"></div>
      </div>

      <button 
        class="testimonial-nav next" 
        aria-label="Next testimonial"
        data-nav="next"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  {% endif %}
</div>

<script src="{{ 'testimonials.js' | asset_url }}" defer></script>
{% endif %}

{% schema %}
{
  "name": "Testimonials",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "paragraph",
      "content": "Add up to 3 testimonials. Leave name blank to hide a testimonial. 2+ testimonials = slider."
    },
    {
      "type": "color",
      "id": "arrow_color",
      "label": "Arrow Color",
      "default": "#1f2937"
    },
    {
      "type": "color",
      "id": "arrow_hover_color",
      "label": "Arrow Hover Color",
      "default": "#2563eb"
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot Color (Inactive)",
      "default": "#cbd5e1"
    },
    {
      "type": "color",
      "id": "dot_active_color",
      "label": "Dot Color (Active)",
      "default": "#2563eb"
    },
    {
      "type": "color",
      "id": "dot_hover_color",
      "label": "Dot Hover Color",
      "default": "#6b7280"
    },
    {
      "type": "image_picker",
      "id": "avatar_1",
      "label": "Avatar 1"
    },
    {
      "type": "text",
      "id": "name_1",
      "label": "Name 1",
      "default": "Sarah Johnson"
    },
    {
      "type": "select",
      "id": "rating_1",
      "label": "Rating 1",
      "options": [
        { "value": "5", "label": "★★★★★" },
        { "value": "4", "label": "★★★★" },
        { "value": "3", "label": "★★★" },
        { "value": "2", "label": "★★" },
        { "value": "1", "label": "★" }
      ],
      "default": "5"
    },
    {
      "type": "textarea",
      "id": "review_1",
      "label": "Review 1",
      "default": "Absolutely love this product!"
    },
    {
      "type": "image_picker",
      "id": "avatar_2",
      "label": "Avatar 2"
    },
    {
      "type": "text",
      "id": "name_2",
      "label": "Name 2",
      "default": "Michael Chen"
    },
    {
      "type": "select",
      "id": "rating_2",
      "label": "Rating 2",
      "options": [
        { "value": "5", "label": "★★★★★" },
        { "value": "4", "label": "★★★★" },
        { "value": "3", "label": "★★★" },
        { "value": "2", "label": "★★" },
        { "value": "1", "label": "★" }
      ],
      "default": "4"
    },
    {
      "type": "textarea",
      "id": "review_2",
      "label": "Review 2",
      "default": "Great value for money!"
    },
    {
      "type": "image_picker",
      "id": "avatar_3",
      "label": "Avatar 3"
    },
    {
      "type": "text",
      "id": "name_3",
      "label": "Name 3",
      "default": "Emma Davis"
    },
    {
      "type": "select",
      "id": "rating_3",
      "label": "Rating 3",
      "options": [
        { "value": "5", "label": "★★★★★" },
        { "value": "4", "label": "★★★★" },
        { "value": "3", "label": "★★★" },
        { "value": "2", "label": "★★" },
        { "value": "1", "label": "★" }
      ],
      "default": "5"
    },
    {
      "type": "textarea",
      "id": "review_3",
      "label": "Review 3",
      "default": "Perfect! Exactly what I needed."
    }
  ]
}
{% endschema %}
